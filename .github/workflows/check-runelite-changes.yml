name: Check RuneLite Changes

on:
  schedule:
    # Check every 3 hours on Monday-Wednesday from 7am to 5pm UTC
    - cron: '0 7,10,13,16 * * 1-3'
  workflow_dispatch: # Allow manual triggering

jobs:
  check-changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Check for RuneLite gameval changes
        id: check-runelite
        run: |
          python << 'EOF'
          import requests
          import os
          
          # Gameval file paths in RuneLite repo
          gameval_files = {
              "runelite-api/src/main/java/net/runelite/api/gameval/NpcID.java",
              "runelite-api/src/main/java/net/runelite/api/gameval/ObjectID.java",
              "runelite-api/src/main/java/net/runelite/api/gameval/ObjectID1.java",
              "runelite-api/src/main/java/net/runelite/api/gameval/AnimationID.java",
              "runelite-api/src/main/java/net/runelite/api/gameval/SpotanimID.java"
          }
          
          # Get the latest commit SHA from RuneLite master branch
          api_url = "https://api.github.com/repos/runelite/runelite/commits/master"
          response = requests.get(api_url, timeout=30)
          response.raise_for_status()
          latest_commit = response.json()
          latest_sha = latest_commit["sha"]
          
          # Check last 10 commits for gameval file changes
          commits_url = "https://api.github.com/repos/runelite/runelite/commits?per_page=10"
          response = requests.get(commits_url, timeout=30)
          response.raise_for_status()
          commits = response.json()
          
          if not commits:
              print("No commits found")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"has_changes=false\n")
                  f.write(f"latest_sha={latest_sha}\n")
              exit(0)
          
          # Check files in recent commits
          files_changed = False
          for commit in commits:
              commit_url = f"https://api.github.com/repos/runelite/runelite/commits/{commit['sha']}"
              commit_response = requests.get(commit_url, timeout=30)
              commit_response.raise_for_status()
              commit_data = commit_response.json()
              
              for file in commit_data.get("files", []):
                  if file["filename"] in gameval_files:
                      files_changed = True
                      print(f"Found change in {file['filename']} (commit: {commit['sha'][:7]})")
                      break
              
              if files_changed:
                  break
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"latest_sha={latest_sha}\n")
              if files_changed:
                  print("Gameval files changed in recent commits")
                  f.write("has_changes=true\n")
              else:
                  print("No gameval file changes detected in recent commits")
                  f.write("has_changes=false\n")
          EOF
      
      - name: Trigger update workflow
        if: steps.check-runelite.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'update-gamevals.yml',
              ref: 'master'
            });

